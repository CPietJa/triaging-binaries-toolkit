# Variables
LIBELF_DIR=../include/libelf
LIBELF=$(LIBELF_DIR)/elf.o $(LIBELF_DIR)/print.o $(LIBELF_DIR)/str.o $(LIBELF_DIR)/libbele/beget.o $(LIBELF_DIR)/libbele/leget.o

EDIT_DIST_TEST_EXE=edit_dist_test
CTPH_TEST_EXE=ctph_test
SHINGLE_TABLE_TEST_EXE=shingle_table_test
SIMHASH_TEST_EXE=simhash_test

INCLUDE_DIR=../include
OBJECT_DIR=../src

# Usual compilation flags
CFLAGS=-std=c11 -Wall -Wextra -g -O2
CPPFLAGS=-I../include -DDEBUG
LDFLAGS=-lm -lssl -lcrypto

# Special rules and targets
.PHONY: all tbt clean help

# Rules and targets
all: tbt $(EDIT_DIST_TEST_EXE) $(CTPH_TEST_EXE) $(SHINGLE_TABLE_TEST_EXE) $(SIMHASH_TEST_EXE)
	
tbt:
	@cd ../src && $(MAKE)

$(EDIT_DIST_TEST_EXE): edit_dist_test.o $(OBJECT_DIR)/edit_dist.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

edit_dist_test.o: edit_dist_test.c $(INCLUDE_DIR)/edit_dist.h
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<

$(CTPH_TEST_EXE): ctph_test.o $(OBJECT_DIR)/ctph.o $(OBJECT_DIR)/elf_manager.o $(LIBELF) $(OBJECT_DIR)/edit_dist.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

ctph_test.o: ctph_test.c $(INCLUDE_DIR)/ctph.h $(INCLUDE_DIR)/edit_dist.h
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<

$(SHINGLE_TABLE_TEST_EXE): shingle_table_test.o $(OBJECT_DIR)/shingle_table.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

shingle_table_test.o: shingle_table_test.c $(INCLUDE_DIR)/shingle_table.h
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<

$(SIMHASH_TEST_EXE): simhash_test.o $(OBJECT_DIR)/simhash.o $(OBJECT_DIR)/shingle_table.o $(OBJECT_DIR)/elf_manager.o $(LIBELF)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

simhash_test.o: simhash_test.c $(INCLUDE_DIR)/simhash.h
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<

clean:
	@cd ../src && $(MAKE) clean
	@rm -f *.o
	@rm -f $(EDIT_DIST_TEST_EXE) $(CTPH_TEST_EXE)
	@rm -f $(SHINGLE_TABLE_TEST_EXE)
	@rm -f $(SIMHASH_TEST_EXE)

help:
	@echo "Usage:"
	@echo "  make [all]\t\tBuild the tests"
	@echo "  make clean\t\tRemove all files generated by make"
	@echo "  make help\t\tDisplay this help"